# Telegraf configuration for Switch MQTT Telemetry
#
# Pipeline: MQTT (switch/telemetry) → InfluxDB 2.x (switch_telemetry bucket)
#
# Telegraf auto-flattens nested JSON objects using underscores:
#   { "battery": { "percentage": 72 } }  →  field: battery_percentage = 72

[agent]
  interval = "5s"
  flush_interval = "5s"

# ── Input: MQTT consumer ──────────────────────────────────────────────

[[inputs.mqtt_consumer]]
  servers = ["tcp://mosquitto:1883"]
  topics = ["switch/telemetry"]
  data_format = "json"

  # String fields that should NOT be parsed as numbers
  json_string_fields = [
    "battery_charger_type",
    "wifi_ip"
  ]

  # Tag the measurement with the MQTT topic
  topic_tag = "topic"

# ── Output: InfluxDB 2.x ─────────────────────────────────────────────

[[outputs.influxdb_v2]]
  urls = ["http://influxdb:8086"]
  token = "switch-telemetry-token"
  organization = "switch"
  bucket = "switch_telemetry"
